{% extends "base.html" %}
{% block title %}Generate Video{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4">ðŸŽ¬ Create Animated Video</h2>

  <!-- Notification Toast -->
  <div id="notification" class="alert text-center" style="display:none;"></div>

  <!-- Debug info (optional) -->
  {% if debug_mode %}
  <div class="alert alert-secondary mb-4" style="font-size:.9em;">
    <strong>Debug:</strong><br/>
    Role: {{ session.get("role") }}<br/>
    Source: {{ source }}<br/>
    Classroom: {{ classroom_id }}<br/>
    Assignment: {{ assignment_id }}
  </div>
  {% endif %}

  <!-- Audio: Upload / TTS / Record -->
  <div class="row mb-4">
    <!-- Upload MP3 -->
    <div class="col-md-4">
      <div class="card mb-3"><div class="card-body">
        <h5><i class="fas fa-upload me-2"></i>Upload MP3 Voice</h5>
        <form id="uploadMp3Form">
          <input type="file" accept=".mp3" id="mp3FileInput" class="form-control mb-2" required>
          <input type="text" id="voiceNameInput" class="form-control mb-2" placeholder="Voice Name (optional)">
          <button class="btn btn-success">Upload</button>
        </form>
      </div></div>
    </div>
    <!-- TTS -->
    <div class="col-md-4">
      <div class="card mb-3"><div class="card-body">
        <h5><i class="fas fa-magic me-2"></i>Generate from Text</h5>
        <form id="gttsForm">
          <textarea id="gttsText" class="form-control mb-2" rows="3" placeholder="Enter text..."></textarea>
          <button class="btn btn-warning">Generate Voice</button>
        </form>
        <div id="tts-preview" class="mt-2" style="display:none;">
          <strong>Preview:</strong>
          <audio id="tts-audio" controls class="w-100 mt-1"></audio>
        </div>
      </div></div>
    </div>
    <!-- Record -->
    <div class="col-md-4">
      <div class="card mb-3"><div class="card-body text-center">
        <h5><i class="fas fa-microphone me-2"></i>Record Your Voice</h5>
        <button id="startRecording" class="btn btn-outline-primary mb-2">Start</button>
        <button id="stopRecording" class="btn btn-outline-danger mb-2" disabled>Stop</button>
        <div id="recorded-audio-container" style="display:none;">
          <audio id="recordedAudio" controls class="w-100 mb-2"></audio>
          <input type="text" id="recording-name" class="form-control mb-2" placeholder="Name (optional)">
          <button id="saveRecording" class="btn btn-success me-1">Save</button>
          <button id="deleteRecording" class="btn btn-danger">Discard</button>
        </div>
      </div></div>
    </div>
  </div>

  <!-- Saved Voices -->
  <div class="card mb-4"><div class="card-body">
    <h5><i class="fas fa-save me-2"></i>Saved Voices</h5>
    {% if voice_records %}
    <div id="saved-voices-list" class="list-group">
      {% for rec in voice_records %}
      <label class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <input name="audio_choice" type="radio" class="form-check-input me-2"
                 value="{{ rec.audio_id }}" id="voice{{ loop.index }}">
          <label for="voice{{ loop.index }}">{{ rec.text or "Voice " ~ loop.index }}</label>
          {% if rec.source == 'recording' %}<span class="badge bg-danger ms-1">Recording</span>{% endif %}
          {% if rec.source == 'upload'    %}<span class="badge bg-info   ms-1">Upload</span>{% endif %}
        </div>
        <div>
          <button class="btn btn-sm btn-outline-primary play-voice" data-audio-id="{{ rec.audio_id }}">
            <i class="fas fa-play"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary edit-voice"
                  data-audio-id="{{ rec.audio_id }}" data-current-name="{{ rec.text }}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-voice"
                  data-audio-id="{{ rec.audio_id }}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </label>
      {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info mb-0">
      <i class="fas fa-info-circle me-2"></i>You haven't saved any voices yet.
    </div>
    {% endif %}
  </div></div>

  <!-- Avatar Picker -->
  <div class="card mb-4"><div class="card-body">
    <h5><i class="fas fa-user-astronaut me-2"></i>Choose Avatar</h5>
    <div class="row g-3" id="avatar-selection">
      {% for av in avatars %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="avatar-card card h-100 text-center p-3">
          <img src="{{ url_for('boundary.stream_avatar',avatar_id=av._id) }}"
               class="img-fluid rounded-circle mb-2 avatar-img"/>
          <h6 class="mb-1">{{ av.name }}</h6>
          <input type="radio" name="avatar_id" id="avatar{{ loop.index }}"
                 class="btn-check" value="{{ av._id }}" required>
          <label class="btn btn-outline-primary btn-sm" for="avatar{{ loop.index }}">Select</label>
        </div>
      </div>
      {% endfor %}
      {% if not avatars %}
      <div class="alert alert-warning">No avatars available. Please create one first.</div>
      {% endif %}
    </div>
  </div></div>

  <!-- Title & Generate -->
  <div class="mb-3">
    <label for="videoTitle" class="form-label">Video Title</label>
    <input type="text" id="videoTitle" class="form-control" placeholder="Enter a title" required>
  </div>
  <div class="text-center mb-4">
    <button id="generateVideoBtn" class="btn btn-primary btn-lg px-5">
      <i class="fas fa-film me-2"></i>Generate Video
    </button>
  </div>

  <!-- Progress Bar -->
  <div id="progress-container" class="mb-4" style="display:none;">
    <div class="d-flex justify-content-between mb-1">
      <span id="progress-status">Preparingâ€¦</span>
      <span id="progress-percent">0%</span>
    </div>
    <div class="progress" style="height:20px;">
      <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width:0%;"></div>
    </div>
  </div>

  <!-- Preview & Actions -->
  <div id="video-preview-container" class="card p-4 text-center" style="display:none;">
    <h5 class="mb-3"><i class="fas fa-play-circle me-2"></i>Video Preview</h5>
    <h4 id="videoTitleDisplay" class="mb-3"></h4>
    <div id="video-preview" class="mb-3"></div>

    <div id="video-actions" class="mb-3">
      {% if session.get("role") == "Student" and source == "submission" %}
        <button id="submitVideoAssignment" class="btn btn-success me-2">
          <i class="fas fa-paper-plane me-1"></i>Submit Assignment
        </button>
      {% elif session.get("role") == "Teacher" and source == "assignment" %}
        <button id="publishAssignment" class="btn btn-warning me-2">
          <i class="fas fa-bullhorn me-1"></i>Publish to Class
        </button>
      {% elif session.get("role") == "Admin" %}
        <button id="goMyVideos" class="btn btn-info me-2">
          <i class="fas fa-video me-1"></i>Go to My Videos
        </button>
      {% endif %}
      <button id="downloadVideo" class="btn btn-secondary">
        <i class="fas fa-download me-1"></i>Download Video
      </button>
    </div>

    <!-- Hidden fields -->
    <input type="hidden" id="videoIdInput"      value="{{ video_id or '' }}">
    <input type="hidden" id="assignmentIdInput" value="{{ assignment_id or '' }}">
    <input type="hidden" id="classroomIdInput"  value="{{ classroom_id or '' }}">
    <input type="hidden" id="sourceInput"       value="{{ source or '' }}">
  </div>

  <!-- Modals -->
  {% include "modals/editVoiceModal.html" %}
  {% include "modals/deleteVoiceModal.html" %}
</div>
{% endblock %}

<style>
  .bg-purple {
    background-color: #6f42c1;
  }

  /* Avatar Card Styling */
  .avatar-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border-color: rgba(111, 66, 193, 0.3);
  }
  .avatar-card.selected {
    border-color: #6f42c1;
    box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.3);
  }
  .avatar-card.selected::after {
    content: "âœ“ Selected";
    position: absolute;
    top: 0;
    right: 0;
    background: #6f42c1;
    color: white;
    padding: 2px 8px;
    font-size: 12px;
    border-bottom-left-radius: 5px;
  }
  .avatar-img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  .avatar-card:hover .avatar-img {
    transform: scale(1.05);
  }
  .avatar-card.selected .avatar-img {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(111, 66, 193, 0.5);
  }
  /* Voice Items */
  .voice-item:hover {
    background-color: #f8f9fa;
  }
  /* Progress Bar */
  #progress-bar {
    transition: width 0.3s ease;
  }
  /* Checkbox Styling */
  .btn-check:checked + .btn-outline-primary {
    background-color: #6f42c1;
    color: white;
    border-color: #6f42c1;
  }
  .btn-check:focus + .btn-outline-primary {
    box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
  }
  /* Voice Play Button */
  .play-voice.playing {
    background-color: #0d6efd;
    color: white;
  }
  /* Voice Name */
  .voice-name {
    max-width: 200px;
    display: inline-block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
  }
</style>
:contentReference[oaicite:0]{index=0}:contentReference[oaicite:1]{index=1}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Element refs
  const note        = document.getElementById('notification');
  const mp3Form     = document.getElementById('uploadMp3Form');
  const mp3File     = document.getElementById('mp3FileInput');
  const voiceName   = document.getElementById('voiceNameInput');

  const gttsForm    = document.getElementById('gttsForm');
  const gttsText    = document.getElementById('gttsText');
  const ttsPreview  = document.getElementById('tts-preview');
  const ttsAudio    = document.getElementById('tts-audio');

  const startRec    = document.getElementById('startRecording');
  const stopRec     = document.getElementById('stopRecording');
  const recContainer= document.getElementById('recorded-audio-container');
  const recAudio    = document.getElementById('recordedAudio');
  const recName     = document.getElementById('recording-name');
  const saveRec     = document.getElementById('saveRecording');
  const delRec      = document.getElementById('deleteRecording');

  const savedList   = document.getElementById('saved-voices-list');
  const audioHidden = document.getElementById('tts-audio-id');

  const avatarInputs= document.querySelectorAll("input[name='avatar_id']");
  const voiceInputs = document.querySelectorAll("input[name='audio_choice']");

  const titleInput  = document.getElementById('videoTitle');
  const genBtn      = document.getElementById('generateVideoBtn');

  const progCont    = document.getElementById('progress-container');
  const progBar     = document.getElementById('progress-bar');
  const progStatus  = document.getElementById('progress-status');
  const progPct     = document.getElementById('progress-percent');

  const previewCont = document.getElementById('video-preview-container');
  const previewDiv  = document.getElementById('video-preview');
  const previewTitle= document.getElementById('videoTitleDisplay');

  const submitBtn   = document.getElementById('submitVideoAssignment');
  const publishBtn  = document.getElementById('publishAssignment');
  const goMyBtn     = document.getElementById('goMyVideos');
  const downloadBtn = document.getElementById('downloadVideo');

  const vidInput    = document.getElementById('videoIdInput');
  const asgInput    = document.getElementById('assignmentIdInput');
  const clsInput    = document.getElementById('classroomIdInput');
  const srcInput    = document.getElementById('sourceInput');

  let state = { mediaRecorder: null, chunks: [], playing: null };

  function showNotification(msg, type='success') {
    note.textContent = msg;
    note.className = `alert alert-${type} text-center`;
    note.style.display = 'block';
    setTimeout(()=> note.style.display='none', 4000);
  }

  // Refresh saved voices
  async function refreshSavedVoices() {
    try {
      const res = await fetch('/list_voices');
      const d   = await res.json();
      if (d.success) {
        savedList.innerHTML = d.records.map((r,i)=>`
          <label class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <input name="audio_choice" type="radio" class="form-check-input me-2"
                     value="${r.audio_id}" id="saved${i}">
              <label for="saved${i}">${r.text||'Voice '+(i+1)}</label>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary play-voice" data-audio-id="${r.audio_id}">
                <i class="fas fa-play"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary edit-voice" data-audio-id="${r.audio_id}" data-current-name="${r.text}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger delete-voice" data-audio-id="${r.audio_id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </label>
        `).join('');
      }
    } catch(e){ console.error(e); }
  }

  // MP3 upload
  mp3Form.addEventListener('submit', async e => {
    e.preventDefault();
    const file = mp3File.files[0];
    if (!file) return showNotification('Select an MP3','danger');
    const form = new FormData();
    form.append('audio', file);
    form.append('name', voiceName.value.trim());
    try {
      const res = await fetch('/upload_mp3_voice',{ method:'POST', body: form });
      const d = await res.json();
      if (d.success) {
        showNotification('MP3 uploaded','success');
        audioHidden.value = d.audio_id;
        await refreshSavedVoices();
      } else throw new Error(d.error);
    } catch(err){ showNotification(err.message,'danger'); }
  });

  // TTS
  gttsForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const txt = gttsText.value.trim();
    if (!txt) return showNotification('Enter text','danger');
    try {
      const res = await fetch('/generate_tts',{ method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text: txt })
      });
      const d = await res.json();
      if (d.success) {
        ttsAudio.src = d.url;
        ttsPreview.style.display = 'block';
        audioHidden.value = d.audio_id;
        await refreshSavedVoices();
      } else throw new Error(d.error);
    } catch(err){ showNotification(err.message,'danger'); }
  });

  // Recording
  startRec.addEventListener('click', async ()=>{
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      state.chunks = [];
      state.mediaRecorder = new MediaRecorder(stream);
      state.mediaRecorder.ondataavailable = e=>state.chunks.push(e.data);
      state.mediaRecorder.start();
      startRec.disabled = true; stopRec.disabled = false;
      showNotification('Recordingâ€¦','info');
    } catch(err){ showNotification('Mic access denied','danger'); }
  });

  stopRec.addEventListener('click', ()=>{
    if (!state.mediaRecorder) return;
    state.mediaRecorder.stop();
    state.mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    stopRec.disabled = true; startRec.disabled = false;
    recContainer.style.display = 'block';
    const blob = new Blob(state.chunks,{ type:'audio/webm' });
    recAudio.src = URL.createObjectURL(blob);
    showNotification('Recording stopped','success');
  });

  saveRec.addEventListener('click', async ()=>{
    if (!state.chunks.length) return showNotification('Nothing to save','danger');
    const blob = new Blob(state.chunks,{ type:'audio/webm' });
    const form = new FormData();
    form.append('audio', blob, 'rec.webm');
    form.append('text',  recName.value.trim());
    form.append('source','recording');
    try {
      const res = await fetch('/upload_recorded_voice',{ method:'POST', body: form });
      const d   = await res.json();
      if (d.success) {
        showNotification('Recording saved','success');
        recContainer.style.display='none';
        await refreshSavedVoices();
      } else throw new Error(d.error);
    } catch(err){ showNotification(err.message,'danger'); }
  });

  delRec.addEventListener('click', ()=>{
    state.chunks = [];
    recContainer.style.display = 'none';
    showNotification('Recording discarded','info');
  });

  // Play/Edit/Delete Saved Voices
  document.addEventListener('click', async e=>{
    const playBtn = e.target.closest('.play-voice');
    if (playBtn) {
      const aid = playBtn.dataset.audioId;
      let audioEl = document.getElementById('aud'+aid);
      if (!audioEl) {
        audioEl = document.createElement('audio');
        audioEl.id  = 'aud'+aid;
        audioEl.src = `/stream_audio/${aid}`;
        document.body.appendChild(audioEl);
      }
      if (state.playing && state.playing!==audioEl) {
        state.playing.pause();
        document.querySelector('.playing')?.classList.remove('playing');
      }
      if (audioEl.paused) {
        audioEl.play(); playBtn.classList.add('playing');
        state.playing = audioEl;
        audioEl.onended=()=> playBtn.classList.remove('playing');
      } else {
        audioEl.pause(); playBtn.classList.remove('playing');
      }
      return;
    }
    // â€¦edit-voice & delete-voice handlers similarlyâ€¦
  });

  // Poll helper
  async function pollForVideo(taskId, avatarId, audioId, title) {
    let tries=0, max=40, interval=3000;
    return new Promise((resolve,reject)=>{
      const timer = setInterval(async ()=>{
        tries++;
        try {
          const res = await fetch(`/check_video/${taskId}`),
                d   = await res.json();
          if (d.ready && d.video_id) {
            clearInterval(timer);
            // save
            await fetch('/save_generated_video',{ method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ avatar_id:avatarId,audio_id:audioId,video_id:d.video_id,title })
            });
            resolve(d.video_id);
          } else if (tries>=max) {
            clearInterval(timer);
            reject(new Error('Generation timed out'));
          } else {
            const pct = Math.min(95, Math.round((tries/max)*100));
            progStatus.textContent = `Generatingâ€¦ (${tries})`;
            progPct.textContent    = `${pct}%`;
            progBar.style.width    = `${pct}%`;
          }
        } catch(err){ clearInterval(timer); reject(err); }
      }, interval);
    });
  }

  // Generate
  genBtn.addEventListener('click', async ()=>{
    const av = [...avatarInputs].find(i=>i.checked)?.value;
    const ai = [...voiceInputs].find(i=>i.checked)?.value || audioHidden.value;
    const tt = titleInput.value.trim();
    if (!av||!ai||!tt) return showNotification('Select avatar, audio & title','danger');

    genBtn.disabled = true;
    progCont.style.display = 'block';
    progStatus.textContent  = 'Startingâ€¦';
    progPct.textContent     = '0%'; progBar.style.width = '0%';

    try {
      const res = await fetch(`/generate_video/${av}/${ai}`,{method:'POST'}),
            { task_id } = await res.json();
      progStatus.textContent = 'Generatingâ€¦';
      const vidId = await pollForVideo(task_id,av,ai,tt);

      // preview
      previewTitle.textContent = tt;
      vidInput.value           = vidId;
      previewDiv.innerHTML     = `<video src="/stream_video/${vidId}" controls autoplay loop class="w-100 rounded"></video>`;
      progCont.style.display   = 'none';
      previewCont.style.display= 'block';
      showNotification('Video ready!','success');
    } catch(err){
      showNotification(err.message,'danger');
    } finally {
      genBtn.disabled = false;
    }
  });

  // Student Submit
  if (submitBtn) submitBtn.addEventListener('click', async ()=>{
    const vid = vidInput.value, asg = asgInput.value, src = srcInput.value;
    if (!vid||!asg||src!=='submission') return showNotification('Missing data','danger');
    try {
      const res = await fetch('/submit_assignment_video',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ video_id:vid, assignment_id:asg })
      });
      const d = await res.json();
      if (d.success) {
        showNotification('Assignment submitted!','success');
        setTimeout(()=>window.location.href=`/student/assignments/${asg}`,800);
      } else throw new Error(d.error);
    } catch(err){ showNotification(err.message,'danger'); }
  });

  // Teacher Publish
  if (publishBtn) publishBtn.addEventListener('click', async ()=>{
    const vid = vidInput.value, cls = clsInput.value;
    if (!vid||!cls) return showNotification('Missing data','danger');
    try {
      const res = await fetch('/publish_assignment_video',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ video_id:vid, classroom_id:cls })
      });
      const d = await res.json();
      if (d.success) {
        showNotification('Published to class!','success');
        setTimeout(()=>location.reload(),800);
      } else throw new Error(d.error);
    } catch(err){ showNotification(err.message,'danger'); }
  });

  // Admin â†’ My Videos
  if (goMyBtn) goMyBtn.addEventListener('click', ()=>{
    window.location.href = "{{ url_for('boundary.my_videos') }}";
  });

  // Download
  downloadBtn.addEventListener('click', ()=>{
    const vid = vidInput.value;
    if (!vid) return showNotification('No video','danger');
    window.location.href = `/download_video/${vid}`;
  });

  // Initial
  refreshSavedVoices();
});
</script>
